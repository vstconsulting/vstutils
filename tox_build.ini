[tox]
envlist = py38-build
skipsdist = True

[testenv]
passenv = *
setenv =
  CCACHE_DIR = {envdir}/.ccache
  DONT_YARN = false
  build: BUILD_OPTIMIZATION=false
  build: DONT_YARN=true
  NOT_COMPRESS = 1
  wheel: BUILD_OPTIMIZATION=true
changedir = {envdir}
allowlist_externals =
    rm
    ls
    grep
    bash
    yarn
commands =
  rm -rf {toxinidir}/build
  build: bash -ec 'cd {toxinidir} && yarn install --pure-lockfile && yarn build'
  build: python -m build --sdist --wheel --no-isolation --skip-dependency-check --outdir {toxinidir}/dist {toxinidir}
  wheel: python -m build --wheel --no-isolation --skip-dependency-check --outdir {toxinidir}/dist {toxinidir}
deps =
  cython>=0.29.2
  build~=0.10.0
  wheel==0.31.1
  setuptools>=40.8.0
  -rrequirements-doc.txt
  jsmin~=3.0.0
  csscompressor==0.9.5

[testenv:auditwheel]
basepython = python3.8
allowlist_externals =
    bash
    grep
    rm
    ls
commands =
    bash -c "for whl in `ls dist/*.whl | grep -v manylinux | grep linux`; do auditwheel repair --plat manylinux2014_x86_64 $whl -w dist/; rm $whl; done"
deps =
    auditwheel~=5.1.2
